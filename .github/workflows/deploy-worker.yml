name: Deploy Worker with KV ProxyIP Feature

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download and prepare source code
      id: prepare-source
      run: |
        echo "æ­£åœ¨å‡†å¤‡æºç ..."
        
        # å§‹ç»ˆä¸‹è½½æœ€æ–°æºç ä½œä¸ºåŸºå‡†
        echo "ä¸‹è½½æœ€æ–°åŸå§‹ä»£ç ..."
        curl -s -o _worker_original.js https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js
        
        if [ -f _worker_original.js ] && [ -s _worker_original.js ]; then
          echo "âœ… åŸå§‹æºç ä¸‹è½½æˆåŠŸ"
          # ä½¿ç”¨åŸå§‹ä»£ç ä½œä¸ºå·¥ä½œå‰¯æœ¬
          cp _worker_original.js _worker.js
          echo "original_downloaded=true" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ åŸå§‹æºç ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨å½“å‰ç‰ˆæœ¬"
          echo "original_downloaded=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Apply modifications with backup
      id: apply-modifications
      run: |
        echo "å¼€å§‹åº”ç”¨ä¿®æ”¹..."
        
        # å¤‡ä»½åŸå§‹æ–‡ä»¶
        cp _worker.js _worker_backup.js
        
        # æ–¹æ³•1: é¦–å…ˆå°è¯•ä½¿ç”¨æ™ºèƒ½è„šæœ¬åº”ç”¨ä¿®æ”¹
        echo "æ–¹æ³•1: ä½¿ç”¨æ™ºèƒ½è„šæœ¬åº”ç”¨ä¿®æ”¹..."
        if node scripts/apply-to-original.js; then
          echo "âœ… æ™ºèƒ½è„šæœ¬åº”ç”¨æˆåŠŸ"
          echo "modification_applied=true" >> $GITHUB_OUTPUT
          echo "method_used=smart_script" >> $GITHUB_OUTPUT
        else
          echo "âŒ æ™ºèƒ½è„šæœ¬å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2: Gitè¡¥ä¸..."
          
          # æ¢å¤å¤‡ä»½
          cp _worker_backup.js _worker.js
          
          # æ–¹æ³•2: å°è¯•åº”ç”¨Gitè¡¥ä¸
          if [ -f kv_proxyip_feature_correct.patch ]; then
            if git apply --check kv_proxyip_feature_correct.patch; then
              git apply kv_proxyip_feature_correct.patch
              echo "âœ… Gitè¡¥ä¸åº”ç”¨æˆåŠŸ"
              echo "modification_applied=true" >> $GITHUB_OUTPUT
              echo "method_used=git_patch" >> $GITHUB_OUTPUT
            else
              echo "âŒ Gitè¡¥ä¸å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3: æ‰‹åŠ¨æ¨¡å¼åŒ¹é…..."
              
              # æ¢å¤å¤‡ä»½
              cp _worker_backup.js _worker.js
              
              # æ–¹æ³•3: ä½¿ç”¨å¢å¼ºçš„æ¨¡å¼åŒ¹é…
              if node scripts/apply-enhanced.js; then
                echo "âœ… å¢å¼ºæ¨¡å¼åŒ¹é…æˆåŠŸ"
                echo "modification_applied=true" >> $GITHUB_OUTPUT
                echo "method_used=enhanced_pattern" >> $GITHUB_OUTPUT
              else
                echo "âŒ æ‰€æœ‰è‡ªåŠ¨æ–¹æ³•éƒ½å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¹²é¢„"
                echo "modification_applied=false" >> $GITHUB_OUTPUT
                echo "method_used=failed" >> $GITHUB_OUTPUT
                
                # æ¢å¤ä¸ºåŸå§‹ä»£ç ï¼Œè‡³å°‘ä¿è¯å¯ä»¥éƒ¨ç½²
                cp _worker_backup.js _worker.js
              fi
            fi
          else
            echo "âŒ è¡¥ä¸æ–‡ä»¶ä¸å­˜åœ¨"
            echo "modification_applied=false" >> $GITHUB_OUTPUT
            echo "method_used=no_patch" >> $GITHUB_OUTPUT
          fi
        fi
        
        # æ¸…ç†å¤‡ä»½æ–‡ä»¶
        rm -f _worker_backup.js _worker_original.js
        
    - name: Upload modified source code
      if: steps.apply-modifications.outputs.modification_applied == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: modified-worker
        path: _worker.js
        retention-days: 1

    - name: Show modification summary
      run: |
        echo "âœ… æºä»£ç ä¿®æ”¹å®Œæˆ!"
        echo "ä½¿ç”¨çš„æ–¹æ³•: ${{ steps.apply-modifications.outputs.method_used }}"
        echo "ä¿®æ”¹åçš„æ–‡ä»¶å·²ä¿å­˜ä¸ºåˆ¶å“: modified-worker"
        echo "å¯ä»¥ç›´æ¥ä½¿ç”¨æˆ–æ‰‹åŠ¨éƒ¨ç½²åˆ°Cloudflare"
        
    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const message = 'ğŸš¨ æºä»£ç ä¿®æ”¹å¤±è´¥ï¼è¯·æ£€æŸ¥è¡¥ä¸æ˜¯å¦ä¸æœ€æ–°ä»£ç å†²çªã€‚';
          
          if (context.payload.pull_request) {
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message + ' PR: #' + context.payload.pull_request.number
            });
          }
          
          console.log('ä¿®æ”¹å¤±è´¥é€šçŸ¥å·²å‡†å¤‡');