name: æ··æ·†æœ€æ–°ç‰ˆæœ¬æºç å¹¶é›†æˆKVæ”¯æŒ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹è‡ªåŠ¨è¿è¡Œ

jobs:
  obfuscate-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g javascript-obfuscator
          npm install axios

      - name: å¤‡ä»½åŸå§‹æ–‡ä»¶
        run: |
          if [ -f "_worker.js" ]; then
            cp _worker.js _worker.js.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… åŸå§‹æ–‡ä»¶å·²å¤‡ä»½"
          fi

      - name: ä¸‹è½½æœ€æ–°å®˜æ–¹æºç 
        run: |
          # æ›¿æ¢ä¸ºå®é™…çš„å®˜æ–¹æºç URL
          OFFICIAL_URL="https://github.com/cmliu/edgetunnel/blob/main/_worker.js"
          curl -s "$OFFICIAL_URL" -o æ˜æ–‡æºç .js
          
          if [ ! -s "æ˜æ–‡æºç .js" ]; then
            echo "âŒ ä¸‹è½½å®˜æ–¹æºç å¤±è´¥"
            exit 1
          fi
          echo "âœ… å®˜æ–¹æºç ä¸‹è½½æˆåŠŸ"

      - name: æ··æ·†ä»£ç 
        run: |
          javascript-obfuscator æ˜æ–‡æºç .js --output _worker_temp.js \
          --compact true \
          --control-flow-flattening true \
          --control-flow-flattening-threshold 1 \
          --dead-code-injection true \
          --dead-code-injection-threshold 1 \
          --identifier-names-generator hexadecimal \
          --rename-globals true \
          --string-array true \
          --string-array-encoding 'rc4' \
          --string-array-threshold 1 \
          --transform-object-keys true \
          --unicode-escape-sequence true
          
          echo "âœ… ä»£ç æ··æ·†å®Œæˆ"

      - name: åº”ç”¨KVæ”¯æŒåŠŸèƒ½
        run: |
          # ä½¿ç”¨Node.jsè„šæœ¬åº”ç”¨KVæ”¯æŒ
          node update_kv_worker.js _worker_temp.js _worker.js
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f _worker_temp.js æ˜æ–‡æºç .js
          echo "âœ… KVæ”¯æŒåŠŸèƒ½å·²åº”ç”¨"

      - name: éªŒè¯è¯­æ³•
        run: node -c _worker.js

      - name: æµ‹è¯•KVåŠŸèƒ½
        run: |
          # éªŒè¯KVç›¸å…³åŠŸèƒ½æ˜¯å¦å­˜åœ¨
          if grep -q "env\.KV" _worker.js && grep -q "PROXYIP" _worker.js; then
            echo "âœ… KVåŠŸèƒ½éªŒè¯é€šè¿‡"
          else
            echo "âŒ KVåŠŸèƒ½æœªæ­£ç¡®åº”ç”¨"
            exit 1
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add _worker.js
          if git diff --cached --quiet; then
            echo "ğŸŸ¡ æ— æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ”§ [è‡ªåŠ¨åŒ–] æ··æ·†ä»£ç å¹¶é›†æˆKVæ”¯æŒåŠŸèƒ½ - $(date +%Y-%m-%d)"
            echo "âœ… æ›´æ”¹å·²æäº¤"
          fi

      - name: æ¨é€æ›´æ”¹
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: æ¸…ç†å·¥ä½œåŒº
        run: |
          # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½æ–‡ä»¶
          ls -t _worker.js.backup.* | tail -n +6 | xargs rm -f 2>/dev/null || true
          echo "âœ… å·¥ä½œåŒºæ¸…ç†å®Œæˆ"
