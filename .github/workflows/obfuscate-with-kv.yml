name: ä»…æ›´æ–°KVæ”¯æŒåŠŸèƒ½

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹è‡ªåŠ¨è¿è¡Œ

jobs:
  update-kv-support:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: å¤‡ä»½åŸå§‹æ–‡ä»¶
        run: |
          if [ -f "_worker.js" ]; then
            cp _worker.js _worker.js.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… åŸå§‹æ–‡ä»¶å·²å¤‡ä»½"
          fi

      - name: ä¸‹è½½æœ€æ–°å®˜æ–¹æºç 
        run: |
          # æ›¿æ¢ä¸ºå®é™…çš„å®˜æ–¹æºç URL
          OFFICIAL_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js"
          curl -s "$OFFICIAL_URL" -o _worker_official.js
          
          if [ ! -s "_worker_official.js" ]; then
            echo "âŒ ä¸‹è½½å®˜æ–¹æºç å¤±è´¥"
            exit 1
          fi
          echo "âœ… å®˜æ–¹æºç ä¸‹è½½æˆåŠŸ"

      - name: æ³¨å…¥è‡ªå®šä¹‰ proxy åˆå§‹åŒ–åˆ° _worker_official.js
        run: |
          if [ -f "scripts/injectProxyInit.js" ]; then
            node scripts/injectProxyInit.js
            echo "âœ… å·²è¿è¡Œæ³¨å…¥å™¨è„šæœ¬"
          else
            echo "âš ï¸ injectProxyInit.js ä¸å­˜åœ¨ï¼Œè·³è¿‡æ³¨å…¥"
          fi

      - name: éªŒè¯æ–‡ä»¶
        run: |
          if [ -f "_worker.js" ] && [ -s "_worker.js" ]; then
            echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < _worker.js) å­—èŠ‚"
          else
            echo "âŒ æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: æ›´æ–°wrangler.tomlåç§°
        run: |
          # åœ¨wrangler.tomlçš„nameä¸­æ·»åŠ æ—¶é—´æˆ³
          if [ -f "wrangler.toml" ]; then
            TIMESTAMP=$(date +%Y%m%d-%H%M)
            # ç®€å•ç›´æ¥çš„æ–¹æ³•ï¼šè¯»å–ç¬¬ä¸€è¡Œå¹¶ä¿®æ”¹
            FIRST_LINE=$(head -1 wrangler.toml)
            if echo "$FIRST_LINE" | grep -q '^name *= *"'; then
              # æå–å¼•å·å†…çš„åç§°
              CURRENT_NAME=$(echo "$FIRST_LINE" | sed 's/^name *= *"\([^"]*\)".*/\1/')
              NEW_NAME="${CURRENT_NAME}-${TIMESTAMP}"
              # ç›´æ¥æ›¿æ¢æ•´è¡Œ
              sed -i "1s/.*/name = \"${NEW_NAME}\"/" wrangler.toml
              echo "âœ… å·²æ›´æ–°wrangler.tomlåç§°: ${NEW_NAME}"
              
              # éªŒè¯æ˜¯å¦çœŸçš„æ›´æ”¹äº†
              if grep -q "${NEW_NAME}" wrangler.toml; then
                echo "âœ… åç§°æ›´æ–°éªŒè¯æˆåŠŸ"
              else
                echo "âŒ åç§°æ›´æ–°å¤±è´¥ï¼Œå½“å‰å†…å®¹:"
                head -1 wrangler.toml
              fi
            else
              echo "âš ï¸  ç¬¬ä¸€è¡Œä¸æ˜¯nameå®šä¹‰ï¼Œè·³è¿‡åç§°æ›´æ–°"
              echo "ç¬¬ä¸€è¡Œå†…å®¹: $FIRST_LINE"
            fi
          else
            echo "âš ï¸  wrangler.tomlä¸å­˜åœ¨ï¼Œè·³è¿‡åç§°æ›´æ–°"
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add _worker.js wrangler.toml
          if git diff --cached --quiet; then
            echo "ğŸŸ¡ æ— æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ”§ [è‡ªåŠ¨åŒ–] æ›´æ–°KVæ”¯æŒåŠŸèƒ½ - $(date +%Y-%m-%d)"
            echo "âœ… æ›´æ”¹å·²æäº¤"
          fi

      - name: æ¨é€æ›´æ”¹
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: æ¸…ç†æ—§å¤‡ä»½
        run: |
          # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½æ–‡ä»¶
          ls -t _worker.js.backup.* 2>/dev/null | tail -n +6 | xargs rm -f 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"
