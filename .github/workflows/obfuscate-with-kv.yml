name: æ··æ·†æœ€æ–°ç‰ˆæœ¬æºç å¹¶é›†æˆKVæ”¯æŒ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´2ç‚¹è‡ªåŠ¨è¿è¡Œ

jobs:
  obfuscate-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: è®¾ç½®Node.jsç¯å¢ƒ
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: å®‰è£…ä¾èµ–
        run: |
          npm install -g javascript-obfuscator
          npm install axios

      - name: å¤‡ä»½åŸå§‹æ–‡ä»¶
        run: |
          if [ -f "_worker.js" ]; then
            cp _worker.js _worker.js.backup.$(date +%Y%m%d_%H%M%S)
            echo "âœ… åŸå§‹æ–‡ä»¶å·²å¤‡ä»½"
          fi

      - name: ä¸‹è½½æœ€æ–°å®˜æ–¹æºç 
        run: |
          # æ›¿æ¢ä¸ºå®é™…çš„å®˜æ–¹æºç URL
          OFFICIAL_URL="https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js"
          curl -s "$OFFICIAL_URL" -o æ˜æ–‡æºç .js
          
          if [ ! -s "æ˜æ–‡æºç .js" ]; then
            echo "âŒ ä¸‹è½½å®˜æ–¹æºç å¤±è´¥"
            exit 1
          fi
          echo "âœ… å®˜æ–¹æºç ä¸‹è½½æˆåŠŸ"

      - name: åº”ç”¨KVæ”¯æŒåŠŸèƒ½
        run: |
          # å…ˆåº”ç”¨KVæ”¯æŒåˆ°æ˜æ–‡ä»£ç 
          node update_kv_worker.js æ˜æ–‡æºç .js _worker_with_kv.js
          echo "âœ… KVæ”¯æŒåŠŸèƒ½å·²åº”ç”¨åˆ°æ˜æ–‡ä»£ç "

      - name: æ··æ·†ä»£ç 
        run: |
          javascript-obfuscator _worker_with_kv.js --output _worker.js \
          --compact true \
          --control-flow-flattening true \
          --control-flow-flattening-threshold 1 \
          --dead-code-injection true \
          --dead-code-injection-threshold 1 \
          --identifier-names-generator hexadecimal \
          --rename-globals true \
          --string-array true \
          --string-array-encoding 'rc4' \
          --string-array-threshold 1 \
          --transform-object-keys true \
          --unicode-escape-sequence true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f _worker_with_kv.js æ˜æ–‡æºç .js
          echo "âœ… ä»£ç æ··æ·†å®Œæˆ"

      - name: è·³è¿‡è¯­æ³•éªŒè¯ï¼ˆESæ¨¡å—ï¼‰
        run: echo "âš ï¸  è·³è¿‡è¯­æ³•éªŒè¯ - Cloudflare Workersä½¿ç”¨ESæ¨¡å—è¯­æ³•"

      - name: éªŒè¯æ··æ·†æ–‡ä»¶å­˜åœ¨
        run: |
          # åªéªŒè¯æ–‡ä»¶æ˜¯å¦æˆåŠŸç”Ÿæˆï¼Œä¸æ£€æŸ¥å…·ä½“å†…å®¹ï¼ˆå› ä¸ºå·²è¢«æ··æ·†ï¼‰
          if [ -f "_worker.js" ] && [ -s "_worker.js" ]; then
            echo "âœ… æ··æ·†æ–‡ä»¶å·²æˆåŠŸç”Ÿæˆ"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < _worker.js) å­—èŠ‚"
          else
            echo "âŒ æ··æ·†æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add _worker.js
          if git diff --cached --quiet; then
            echo "ğŸŸ¡ æ— æ–‡ä»¶æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ”§ [è‡ªåŠ¨åŒ–] æ··æ·†ä»£ç å¹¶é›†æˆKVæ”¯æŒåŠŸèƒ½ - $(date +%Y-%m-%d)"
            echo "âœ… æ›´æ”¹å·²æäº¤"
          fi

      - name: æ¨é€æ›´æ”¹
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: æ¸…ç†å·¥ä½œåŒº
        run: |
          # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½æ–‡ä»¶
          ls -t _worker.js.backup.* | tail -n +6 | xargs rm -f 2>/dev/null || true
          echo "âœ… å·¥ä½œåŒºæ¸…ç†å®Œæˆ"
