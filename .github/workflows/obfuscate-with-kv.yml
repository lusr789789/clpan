name: Deploy Worker with KV ProxyIP Feature

on:
  push:

  pull_request:


jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download latest source code
      id: download-source
      run: |
        echo "æ­£åœ¨ä¸‹è½½æœ€æ–°çš„åŸå§‹ä»£ç ..."
        curl -s -o _worker_latest.js https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js
        
        if [ -f _worker_latest.js ] && [ -s _worker_latest.js ]; then
          echo "âœ… æœ€æ–°æºç ä¸‹è½½æˆåŠŸ"
          # æ›¿æ¢å½“å‰æ–‡ä»¶
          mv _worker_latest.js _worker.js
          echo "source_downloaded=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ æºç ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨å½“å‰ç‰ˆæœ¬"
          echo "source_downloaded=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Apply KV ProxyIP Patch
      id: apply-patch
      run: |
        # æ£€æŸ¥è¡¥ä¸æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f kv_proxyip_feature_correct.patch ]; then
          echo "æ‰¾åˆ°è¡¥ä¸æ–‡ä»¶ï¼Œå¼€å§‹åº”ç”¨..."
          
          # å…ˆå°è¯•ç›´æ¥åº”ç”¨è¡¥ä¸
          if git apply --check kv_proxyip_feature_correct.patch; then
            git apply kv_proxyip_feature_correct.patch
            echo "âœ… è¡¥ä¸åº”ç”¨æˆåŠŸ"
            echo "patch_applied=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ è¡¥ä¸æ— æ³•ç›´æ¥åº”ç”¨ï¼Œå°è¯•ä½¿ç”¨Nodeè„šæœ¬ä¿®å¤..."
            
            # ä½¿ç”¨Nodeè„šæœ¬è¿›è¡Œæ‰‹åŠ¨åˆå¹¶
            if node scripts/apply-to-original.js; then
              echo "âœ… Nodeè„šæœ¬ä¿®å¤æˆåŠŸ"
              echo "patch_applied=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ Nodeè„šæœ¬ä¿®å¤å¤±è´¥ï¼Œå°è¯•ä¸‹è½½æœ€æ–°ä»£ç ååº”ç”¨"
              
              # å¦‚æœä¹‹å‰æ²¡æœ‰ä¸‹è½½æœ€æ–°ä»£ç ï¼Œç°åœ¨ä¸‹è½½
              if [ "${{ steps.download-source.outputs.source_downloaded }}" = "false" ]; then
                curl -s -o _worker.js https://raw.githubusercontent.com/cmliu/edgetunnel/main/_worker.js
              fi
              
              # å†æ¬¡å°è¯•åº”ç”¨è¡¥ä¸
              if node scripts/apply-to-original.js; then
                echo "âœ… æœ€ç»ˆä¿®å¤æˆåŠŸ"
                echo "patch_applied=true" >> $GITHUB_OUTPUT
              else
                echo "âŒ æ‰€æœ‰ä¿®å¤å°è¯•éƒ½å¤±è´¥"
                echo "patch_applied=false" >> $GITHUB_OUTPUT
              fi
            fi
          fi
        else
          echo "âŒ è¡¥ä¸æ–‡ä»¶ä¸å­˜åœ¨"
          echo "patch_applied=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Deploy to Cloudflare
      if: steps.apply-patch.outputs.patch_applied == 'true'
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        command: deploy
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        
    - name: Notify on Failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const message = 'ğŸš¨ éƒ¨ç½²å¤±è´¥ï¼' + 
            (context.payload.pull_request ? 
             'è¯·æ£€æŸ¥è¡¥ä¸æ˜¯å¦ä¸æœ€æ–°ä»£ç å†²çªã€‚PR: #' + context.payload.pull_request.number :
             'ä¸»åˆ†æ”¯éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚');
          
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request?.number || 1,
            body: message
          });
          
          // ä¹Ÿå¯ä»¥å‘é€åˆ°Slackæˆ–å…¶ä»–é€šçŸ¥æ¸ é“
          console.log('éƒ¨ç½²å¤±è´¥é€šçŸ¥å·²å‘é€');
