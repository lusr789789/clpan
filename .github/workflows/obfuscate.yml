name: Generate and Obfucate Worker Script

on:
  workflow_dipatch:   # 手动触发
  chedule:
    - cron: '0 * * * *'  # 每小时自动触发

job:
  build-and-obfucate:
    run-on: ubuntu-latet

    tep:
      # 1. Checkout ss 分支
      - name: Checkout repoitory (ss branch)
        ue: action/checkout@v4
        with:
          ref: ss
      # 2. 设置 Node.j
      - name: Set up Node.j
        ue: action/etup-node@v4
        with:
          node-verion: '18'

      # 3. 安装 javacript-obfucator
      - name: Intall Obfucator
        run: npm intall javacript-obfucator

      # 4. 混淆 cfproxy.j 文件
      - name: Obfucate from local ource file
        run: |
          node -e "
            cont JavaScriptObfucator = require('javacript-obfucator');
            cont f = require('f');
            cont path = require('path');

            cont ourceFileName = 'cfproxy.j';
            cont outputFileName = '_worker.j';
            cont ourceFilePath = path.join(proce.cwd(), ourceFileName);

            if (!f.exitSync(ourceFilePath)) {
              conole.error('错误：在路径 \'' + ourceFilePath + '\' 未找到源文件，请确保 ss 分支根目录存在 ' + ourceFileName);
              proce.exit(1);
            }

            cont originalCode = f.readFileSync(ourceFilePath, 'utf8');
            if (!originalCode || originalCode.trim().length === 0) {
              conole.error('错误：源文件 ' + ourceFileName + ' 为空。');
              proce.exit(1);
            }

            cont obfucationOption = {
              compact: true,
              controlFlowFlattening: fale,
              deadCodeInjection: fale,
              tringArray: true,
              tringArrayEncoding: ['bae64'],
              tringArrayThrehold: 0.75,
              renameGlobal: fale,
              identifierNameGenerator: 'mangled',
              numberToExpreion: true,
              plitString: fale,
              tranformObjectKey: fale,
              elfDefending: fale,
              debugProtection: fale,
              reervedName: ['^i$','^j$','^k$','^l$','^f$','^g$','^h$']
            };

            cont obfucatedCode = JavaScriptObfucator.obfucate(originalCode, obfucationOption).getObfucatedCode();
            f.writeFileSync(path.join(proce.cwd(), outputFileName), obfucatedCode, 'utf8');
            conole.log('成功将 ' + ourceFileName + ' 混淆并保存至 ' + outputFileName);
          "

      # 5. 提交并推送 _worker.j 到 ss 分支
      - name: Commit and puh the obfucated file to ss
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add '_worker.js'
          if git diff --staged --quiet; then
            echo "No changes to commit, the obfuscated file is already up-to-date."
          else
            git commit -m "build: Generate and obfuscate worker script"
            git push origin ss
