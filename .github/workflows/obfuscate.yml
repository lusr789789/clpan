name: Generate and Obfuscate Worker Script

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'

jobs:
  build-and-obfuscate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install JavaScript Obfuscator
        run: npm install javascript-obfuscator

      - name: Obfuscate Worker source file
        run: |
          node <<'EOF'
          const JavaScriptObfuscator = require('javascript-obfuscator');
          const fs = require('fs');
          const path = require('path');

          const sourceFileName = 'cfproxy.js';
          const outputFileName = '_worker.js';
          const sourcePath = path.join(process.cwd(), sourceFileName);

          if (!fs.existsSync(sourcePath)) {
            console.error('âŒ æœªæ‰¾åˆ°æºæ–‡ä»¶:', sourceFileName);
            process.exit(1);
          }

          let originalCode = fs.readFileSync(sourcePath, 'utf8');
          if (!originalCode || !originalCode.trim()) {
            console.error('âŒ æºæ–‡ä»¶ä¸ºç©º');
            process.exit(1);
          }

          // === CUSTOM MODIFICATION / INSERTION POINT ===
          // åœ¨è¿™é‡Œâ€œæ°ä¸€æˆªâ€å¹¶æ›¿æ¢ä¸ºä½ çš„è‡ªå®šä¹‰ä»£ç ç‰‡æ®µï¼ˆæˆ–å¯¹ originalCode åšé¢„å¤„ç†ï¼‰ã€‚
          //
          // æ³¨æ„äº‹é¡¹ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š
          // 1) åªæ›¿æ¢ä¸‹é¢ä¸‰è¡Œæ³¨é‡Šï¼ˆä¸è¦åˆ é™¤ EOF æˆ–å…¶ä»–å¤–å±‚ç»“æ„ï¼‰ã€‚
          // 2) ä½ çš„ä»£ç åº”ä¿æŒä¸å½“å‰ç¼©è¿›ï¼ˆ10 ä¸ªç©ºæ ¼ï¼‰å¯¹é½ï¼ˆè¿™é‡Œçš„ç¼©è¿›æ˜¯ä¸ºäº†å¯è¯»æ€§ï¼›åœ¨è¿™é‡Œ-doc ä¸­ç¼©è¿›ä¸ä¼šå½±å“è¿è¡Œï¼‰ã€‚
          // 3) å¦‚æœä½ çš„ä»£ç åŒ…å«å•å¼•å·æˆ–åŒå¼•å·ï¼Œä¸ä¼šå½±å“è¿™é‡Œ-docï¼ˆå› ä¸ºä½¿ç”¨äº† <<'EOF'ï¼‰ï¼Œä½†è¯·ç¡®ä¿ä½ çš„ JS è¯­æ³•æ­£ç¡®ã€‚
          // 4) ç¤ºä¾‹ï¼šå¦‚æœæƒ³åœ¨æ··æ·†å‰æ›¿æ¢å­—ç¬¦ä¸²å¯ä»¥å†™ï¼š
          //      originalCode = originalCode.replace(/FOO/g, 'BAR');
          //
          // ======= BEGIN INSERT HERE =======
          // ï¼ˆå°†è¿™æ®µæ³¨é‡Šæ•´æ®µæ›¿æ¢ä¸ºä½ çš„ JS ä»£ç ï¼‰
          //
          // =======  END INSERT HERE  =======
          //
          // æ›¿æ¢å®Œæˆåç»§ç»­ä¸‹é¢çš„æ··æ·†æµç¨‹ã€‚
          // =================================

          const obfuscationOptions = {
            compact: true,
            controlFlowFlattening: false,
            deadCodeInjection: false,
            stringArray: true,
            stringArrayEncoding: ['base64'],
            stringArrayThreshold: 0.75,
            rotateStringArray: true,
            renameGlobals: false,
            identifierNamesGenerator: 'mangled',
            numbersToExpressions: false,
            transformObjectKeys: false,
            splitStrings: false,
            selfDefending: false,
            debugProtection: false,
            unicodeEscapeSequence: false,
            target: 'browser',
            reservedNames: [
              '^fetch$',
              '^Request$',
              '^Response$',
              '^addEventListener$',
              '^removeEventListener$',
              '^event$',
              '^handleRequest$',
              '^ENV$',
              '^globalThis$'
            ],
            reservedStrings: []
          };

          const obfuscatedCode = JavaScriptObfuscator.obfuscate(originalCode, obfuscationOptions).getObfuscatedCode();
          fs.writeFileSync(path.join(process.cwd(), outputFileName), obfuscatedCode, 'utf8');
          console.log('âœ… å·²æ··æ·†å®Œæˆï¼Œè¾“å‡ºè‡³ï¼š' + outputFileName);
          EOF

      - name: Quick parse check for generated worker
        run: |
          node <<'EOF'
          const fs = require('fs');
          try {
            const code = fs.readFileSync('_worker.js', 'utf8');
            new Function(code);
            console.log('âœ… _worker.js è¯­æ³•è§£æé€šè¿‡');
          } catch (err) {
            console.error('âŒ _worker.js è¯­æ³•è§£æå¤±è´¥:', err && err.message);
            process.exit(2);
          }
          EOF

      - name: Optional: replace problematic const -> let
        run: |
          if [ -f "_worker.js" ]; then
            # ä¸‹é¢ç¤ºä¾‹ä¸ºä¿å®ˆæ›¿æ¢ï¼šåªé’ˆå¯¹æ—¥å¿—ä¸­å¸¸è§çš„å•å­—ç¬¦ const åï¼ˆI, h, jï¼‰
            # å¦‚æœä½ ä¸éœ€è¦ï¼Œè¯·åˆ æ‰æˆ–æ³¨é‡Šè¿™äº› sed è¡Œ
            sed -E -i.bak -e 's/\bconst\s+I\s*=\s*/let I = /g' _worker.js || true
            sed -E -i.bak -e 's/\bconst\s+h\s*=\s*/let h = /g' _worker.js || true
            sed -E -i.bak -e 's/\bconst\s+j\s*=\s*/let j = /g' _worker.js || true
            echo 'âœ… å·²åº”ç”¨ä¿å®ˆ const->let æ›¿æ¢ï¼ˆç”Ÿæˆ .bak å¤‡ä»½ï¼‰'
          fi

      - name: Commit and push the obfuscated file
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add '_worker.js' || true
          git add '_worker.js.bak' || true
          if git diff --staged --quiet; then
            echo 'âœ… æ— éœ€æ›´æ–°ï¼Œæ··æ·†æ–‡ä»¶å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ã€‚'
          else
            git commit -m 'build: Generate and obfuscate worker script'
            git push
            echo 'ğŸš€ å·²æäº¤æ–°çš„æ··æ·†ç‰ˆæœ¬ã€‚'
          fi
